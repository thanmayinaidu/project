import React, { useState, useMemo, useEffect } from "react";

// PeopleTrackerDashboard.jsx
// Single-file React component for a people-tracking dashboard.
// Styling uses Tailwind classes (ensure Tailwind is available in your project).
// Exports default React component.

export default function PeopleTrackerDashboard() {
  // Example data - replace with API calls in a real app
  const initialPeople = [
    { id: 1, name: "Aisha Khan", role: "Field Agent", status: "Active", location: "Mumbai, India", lastSeen: "2025-09-25T10:12:00Z", notes: "Checking in" },
    { id: 2, name: "Ravi Patel", role: "Coordinator", status: "Offline", location: "Pune, India", lastSeen: "2025-09-24T18:40:00Z", notes: "On leave" },
    { id: 3, name: "Priya Sharma", role: "Volunteer", status: "Active", location: "Delhi, India", lastSeen: "2025-09-26T06:20:00Z", notes: "Arrived at site" },
    { id: 4, name: "Michael Chen", role: "Analyst", status: "Idle", location: "Bengaluru, India", lastSeen: "2025-09-26T02:05:00Z", notes: "Reviewing data" },
    { id: 5, name: "Sara Ali", role: "Driver", status: "Active", location: "Hyderabad, India", lastSeen: "2025-09-25T22:30:00Z", notes: "En route" },
  ];

  const [people, setPeople] = useState(initialPeople);
  const [query, setQuery] = useState("");
  const [statusFilter, setStatusFilter] = useState("All");
  const [sortBy, setSortBy] = useState("lastSeen");
  const [selectedPerson, setSelectedPerson] = useState(null);
  const [page, setPage] = useState(1);
  const PAGE_SIZE = 5;

  // Simple derived dataset
  const filtered = useMemo(() => {
    let list = people.filter(p =>
      p.name.toLowerCase().includes(query.toLowerCase()) ||
      p.role.toLowerCase().includes(query.toLowerCase()) ||
      p.location.toLowerCase().includes(query.toLowerCase())
    );
    if (statusFilter !== "All") list = list.filter(p => p.status === statusFilter);

    const sorted = [...list].sort((a, b) => {
      if (sortBy === "name") return a.name.localeCompare(b.name);
      if (sortBy === "role") return a.role.localeCompare(b.role);
      if (sortBy === "status") return a.status.localeCompare(b.status);
      // default: lastSeen desc
      return new Date(b.lastSeen) - new Date(a.lastSeen);
    });
    return sorted;
  }, [people, query, statusFilter, sortBy]);

  const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
  useEffect(() => { if (page > totalPages) setPage(1); }, [totalPages]);

  // Pagination slice
  const paged = useMemo(() => filtered.slice((page - 1) * PAGE_SIZE, page * PAGE_SIZE), [filtered, page]);

  // Add person (simple form below can call this)
  function addPerson(person) {
    setPeople(prev => [{ ...person, id: Date.now() }, ...prev]);
  }

  // Update person
  function updatePerson(id, patch) {
    setPeople(prev => prev.map(p => p.id === id ? { ...p, ...patch } : p));
  }

  // Delete person
  function removePerson(id) {
    setPeople(prev => prev.filter(p => p.id !== id));
    if (selectedPerson && selectedPerson.id === id) setSelectedPerson(null);
  }

  // Export CSV
  function exportCSV() {
    const header = ["id","name","role","status","location","lastSeen","notes"];
    const rows = people.map(p => header.map(h => JSON.stringify(p[h] ?? "")));
    const csv = [header.join(","), ...rows.map(r => r.join(","))].join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `people_${new Date().toISOString()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Quick simulation of status change (not background â€” user clicks)
  function randomizeStatuses() {
    const statuses = ["Active","Idle","Offline"];
    setPeople(prev => prev.map(p => ({ ...p, status: statuses[Math.floor(Math.random()*statuses.length)], lastSeen: new Date().toISOString() })));
  }

  // Simple import (CSV expected with header matching keys)
  function handleImportFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      const lines = text.split(/\r?\n/).filter(Boolean);
      const header = lines.shift().split(",").map(h => h.replace(/\"/g, "").trim());
      const newPeople = lines.map(line => {
        const cols = line.split(",").map(c => c.replace(/\"/g, "").trim());
        const obj = {};
        header.forEach((h, i) => obj[h] = cols[i] ?? "");
        obj.id = Date.now() + Math.random()*1000;
        return obj;
      });
      setPeople(prev => [...newPeople, ...prev]);
    };
    reader.readAsText(file);
  }

  // Utility: human-friendly time diff
  function timeAgo(ts) {
    const diff = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
    if (diff < 60) return `${diff}s ago`;
    if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
    return `${Math.floor(diff/86400)}d ago`;
  }

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <header className="max-w-7xl mx-auto flex items-center justify-between mb-6">
        <h1 className="text-2xl font-semibold">People Tracker Dashboard</h1>
        <div className="flex gap-3 items-center">
          <button onClick={randomizeStatuses} className="px-3 py-2 bg-indigo-600 text-white rounded shadow-sm">Randomize Status</button>
          <button onClick={exportCSV} className="px-3 py-2 bg-green-600 text-white rounded shadow-sm">Export CSV</button>
          <label className="px-3 py-2 bg-white border rounded cursor-pointer text-sm">
            Import
            <input type="file" accept="text/csv" className="hidden" onChange={(e) => e.target.files?.[0] && handleImportFile(e.target.files[0])} />
          </label>
        </div>
      </header>

      <main className="max-w-7xl mx-auto grid grid-cols-12 gap-6">
        {/* Sidebar / Controls */}
        <aside className="col-span-3 bg-white p-4 rounded shadow">
          <div className="mb-4">
            <input value={query} onChange={(e)=>setQuery(e.target.value)} placeholder="Search name, role, location..." className="w-full p-2 border rounded" />
          </div>
          <div className="mb-4">
            <label className="block text-sm">Status</label>
            <select value={statusFilter} onChange={(e)=>setStatusFilter(e.target.value)} className="w-full p-2 border rounded">
              <option>All</option>
              <option>Active</option>
              <option>Idle</option>
              <option>Offline</option>
            </select>
          </div>
          <div className="mb-4">
            <label className="block text-sm">Sort by</label>
            <select value={sortBy} onChange={(e)=>setSortBy(e.target.value)} className="w-full p-2 border rounded">
              <option value="lastSeen">Last Seen (newest)</option>
              <option value="name">Name</option>
              <option value="role">Role</option>
              <option value="status">Status</option>
            </select>
          </div>

          <div className="mt-6">
            <h3 className="text-sm font-medium mb-2">Add quick person</h3>
            <QuickAddForm onAdd={(p) => addPerson(p)} />
          </div>
        </aside>

        {/* Main list */}
        <section className="col-span-6">
          <div className="bg-white p-4 rounded shadow">
            <h2 className="font-semibold mb-3">People ({filtered.length})</h2>

            <div className="overflow-x-auto">
              <table className="w-full table-auto text-sm">
                <thead>
                  <tr className="text-left text-gray-500">
                    <th className="p-2">Name</th>
                    <th className="p-2">Role</th>
                    <th className="p-2">Location</th>
                    <th className="p-2">Status</th>
                    <th className="p-2">Last Seen</th>
                    <th className="p-2">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {paged.map(p => (
                    <tr key={p.id} className="border-t">
                      <td className="p-2">
                        <div className="font-medium">{p.name}</div>
                        <div className="text-xs text-gray-500">{p.notes}</div>
                      </td>
                      <td className="p-2">{p.role}</td>
                      <td className="p-2">{p.location}</td>
                      <td className="p-2">{p.status}</td>
                      <td className="p-2">{timeAgo(p.lastSeen)}</td>
                      <td className="p-2">
                        <div className="flex gap-2">
                          <button onClick={() => setSelectedPerson(p)} className="px-2 py-1 border rounded text-sm">View</button>
                          <button onClick={() => updatePerson(p.id, { status: p.status === 'Active' ? 'Idle' : 'Active', lastSeen: new Date().toISOString() })} className="px-2 py-1 border rounded text-sm">Toggle</button>
                          <button onClick={() => removePerson(p.id)} className="px-2 py-1 border rounded text-sm text-red-600">Delete</button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Pagination */}
            <div className="mt-4 flex items-center justify-between text-sm">
              <div>Page {page} of {totalPages}</div>
              <div className="flex gap-2">
                <button onClick={() => setPage(p => Math.max(1, p-1))} className="px-2 py-1 border rounded">Prev</button>
                <button onClick={() => setPage(p => Math.min(totalPages, p+1))} className="px-2 py-1 border rounded">Next</button>
              </div>
            </div>
          </div>
        </section>

        {/* Right panel - map / details */}
        <aside className="col-span-3">
          <div className="bg-white p-4 rounded shadow mb-4">
            <h3 className="font-medium mb-3">Live Map (placeholder)</h3>
            <div className="h-48 bg-gray-100 rounded flex items-center justify-center text-gray-400">Map placeholder â€” integrate Mapbox/Leaflet here</div>
            <p className="mt-2 text-xs text-gray-500">Click a person to view details and recent activity.</p>
          </div>

          <div className="bg-white p-4 rounded shadow">
            <h3 className="font-medium mb-3">Details</h3>
            {selectedPerson ? (
              <PersonDetails person={selectedPerson} onUpdate={updatePerson} onClose={() => setSelectedPerson(null)} />
            ) : (
              <div className="text-sm text-gray-500">Select a person to see details.</div>
            )}
          </div>
        </aside>
      </main>
    </div>
  );
}

function QuickAddForm({ onAdd }) {
  const [name, setName] = useState("");
  const [role, setRole] = useState("");
  const [location, setLocation] = useState("");
  function submit(e) {
    e.preventDefault();
    if (!name) return;
    onAdd({ name, role: role || 'Member', status: 'Offline', location: location || 'Unknown', lastSeen: new Date().toISOString(), notes: '' });
    setName(''); setRole(''); setLocation('');
  }
  return (
    <form onSubmit={submit} className="space-y-2">
      <input value={name} onChange={(e)=>setName(e.target.value)} placeholder="Name" className="w-full p-2 border rounded" />
      <input value={role} onChange={(e)=>setRole(e.target.value)} placeholder="Role" className="w-full p-2 border rounded" />
      <input value={location} onChange={(e)=>setLocation(e.target.value)} placeholder="Location" className="w-full p-2 border rounded" />
      <div className="flex justify-end">
        <button type="submit" className="px-3 py-2 bg-indigo-600 text-white rounded">Add</button>
      </div>
    </form>
  );
}

function PersonDetails({ person, onUpdate, onClose }) {
  const [editing, setEditing] = useState(false);
  const [form, setForm] = useState(person);

  useEffect(() => setForm(person), [person]);

  function save() {
    onUpdate(person.id, { ...form });
    setEditing(false);
  }

  return (
    <div>
      <div className="mb-2">
        <div className="text-lg font-medium">{person.name}</div>
        <div className="text-xs text-gray-500">{person.role} â€¢ {person.location}</div>
      </div>

      {editing ? (
        <div className="space-y-2">
          <input className="w-full p-2 border rounded" value={form.role} onChange={(e)=>setForm({...form, role: e.target.value})} />
          <input className="w-full p-2 border rounded" value={form.location} onChange={(e)=>setForm({...form, location: e.target.value})} />
          <textarea className="w-full p-2 border rounded" value={form.notes} onChange={(e)=>setForm({...form, notes: e.target.value})} />
          <div className="flex gap-2 justify-end">
            <button onClick={()=>setEditing(false)} className="px-2 py-1 border rounded">Cancel</button>
            <button onClick={save} className="px-2 py-1 bg-indigo-600 text-white rounded">Save</button>
          </div>
        </div>
      ) : (
        <div>
          <div className="text-sm text-gray-700 mb-2">Status: <span className="font-medium">{person.status}</span></div>
          <div className="text-sm text-gray-700 mb-2">Last seen: {new Date(person.lastSeen).toLocaleString()}</div>
          <div className="text-sm text-gray-700 mb-2">Notes: {person.notes}</div>
          <div className="flex gap-2 mt-3">
            <button onClick={()=>setEditing(true)} className="px-2 py-1 border rounded">Edit</button>
            <button onClick={()=>onUpdate(person.id, { status: person.status === 'Active' ? 'Idle' : 'Active', lastSeen: new Date().toISOString() })} className="px-2 py-1 border rounded">Toggle Status</button>
            <button onClick={onClose} className="px-2 py-1 border rounded text-sm">Close</button>
          </div>
        </div>
      )}
    </div>
  );
}

/*
Notes:
- This is a single-file React component intended to be dropped into a React project that has Tailwind CSS enabled. 
- To integrate as a static HTML + JS bundle (without a React build chain), you'd need to compile this with a bundler (Vite, Create React App, etc.) or adapt to plain JS.
- Map placeholder: integrate Mapbox GL or Leaflet and feed coordinates per person for real tracking.
- For persistent storage, replace local state with API calls (fetch/axios) and websockets for real-time updates.
*/
